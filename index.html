<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Citidentify</title>
  <link rel="stylesheet" href="style/style.css"/>
  <link rel="stylesheet" href="style/buttons.min.css"/>
</head>
<body>
<h2>What city is this?</h2>

<ul>
  <li><button id="choice-1" class="choice pure-button pure-button-primary button-large"></button></li>
  <li><button id="choice-2" class="choice pure-button pure-button-primary button-large"></button></li>
  <li><button id="choice-3" class="choice pure-button pure-button-primary button-large"></button></li>
</ul>

<p><span class="correct">0</span>/<span class="total">0</span></p>

<img id="map-img" src="img/blank.gif"/>

<script src="script/lodash.min.js"></script>
<script src="script/jquery.min.js"></script>
<script src="script/rx.lite.min.js"></script>

<script src="script/cities.js"></script>
<script>
  function shuffle(array) {
    var arr = _.clone(array);
    var currentIndex = arr.length;
    var randomIndex;
    var tmp;

    while (0 !== currentIndex) {
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex -= 1;

      tmp = arr[currentIndex];
      arr[currentIndex] = arr[randomIndex];
      arr[randomIndex] = tmp;
    }

    return arr;
  }

  var sample = function(arr, n) {
    if(isNaN(n)){
      n = 1;
    }
    var shuffled = shuffle(arr);
    return n === 1 ? shuffled[0] : shuffled.slice(0, n);
  };

  var buildUrl = function(city) {
    return "img/cities/" + city.id + ".png";
  }
</script>
<script>
  var $correct = $('.correct');
  var $total = $('.total');
  var $choices = $('.choice');
  var $choice1 = $('#choice-1');
  var $choice2 = $('#choice-2');
  var $choice3 = $('#choice-3');
  var $mapImg = $('#map-img');

  var resultStream = Rx.Observable.fromEvent($choices, 'click')
    .map(function(e) {
      var guess = $(e.target).data('city-id');
      var actual = $mapImg.data('city-id');
      return guess === actual;
    });

  var correctStream = resultStream.scan(0, function(acc, x) {
    return acc + (x ? 1 : 0);
  });
  correctStream.subscribe(function(correct) {
    $correct.text(correct);
  });

  var totalStream = resultStream.scan(0, function(acc) {
    return acc + 1;
  });
  totalStream.subscribe(function(total) {
    $total.text(total);
  });

  var refreshStream = Rx.Observable.return('startup').merge(resultStream);

  refreshStream.subscribe(function(){
    var possible = sample(cities, 3);
    var chosen = sample(possible);
    $choice1.text(possible[0].name).data('city-id', possible[0].id);
    $choice2.text(possible[1].name).data('city-id', possible[1].id);
    $choice3.text(possible[2].name).data('city-id', possible[2].id);
    $mapImg.attr('src', 'img/blank.gif');
    setTimeout(function(){
      $mapImg.attr('src', buildUrl(chosen)).data('city-id', chosen.id);
    }, 0);
  });


</script>

</body>
</html>